

 <!-- Documentation:
   https://daisyui.com/
   https://tailwindcss.com/
   https://www.highcharts.com/
   https://vuejs.org/
   https://pyodide.org/en/stable/
   https://www.papaparse.com/
   https://danfo.jsdata.org/
   https://axios-http.com/docs/intro -->

<!DOCTYPE html>
<html>
<head>
  <title>Baccarat Assistant</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/danfojs@1.1.2/lib/bundle.min.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/boost.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <link rel="icon" href="./gupy_logo.png" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>
<body>
  <div id="app" style="text-align: center;">
    <center>
      <div class="h-full">
        <div class="drawer drawer-end">
          <input id="my-drawer-3" type="checkbox" class="drawer-toggle" /> 

          <div class="drawer-content flex flex-col">
            <!-- Navbar -->
            <div class="w-full navbar bg-base-300">
              <div class="flex-1 px-2">Baccarat</div>
              <div class="flex-none hidden lg:block">
                <ul class="menu menu-horizontal space-x-2">
                  <!-- Navbar menu content here -->
                  <li>
                  <input type="number" placeholder="Banker %" v-model="banker_perc" class="input-sm input-bordered h-full" />
                  </li>
                  <li>
                  <input type="number" placeholder="Min Bet" v-model="min_bet" class="input-sm input-bordered h-full" />
                  </li>
                  <li>
                    <input type="number" placeholder="Max Bet" v-model="max_bet" class="input-sm input-bordered h-full" />
                      </li>
                  <li>
                    <input type="number" placeholder="Max Loss" v-model="max_loss" class="input-sm input-bordered h-full" />
                      </li>
                  <li>
                    <button class="btn btn-sm h-full bg-blue-500 text-base-100" @click="calculate()">Calculate</button>
                  </li>
                </ul>
              </div>
              <div class="flex-none lg:hidden">
                <label for="my-drawer-3" aria-label="open sidebar" class="btn btn-square btn-ghost">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-6 h-6 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </label>
              </div> 
            </div>
            <!-- Page content here -->
            <div v-if="calculated == true">
              <div class="overflow-x-auto">
                <table class="table table-md  table-pin-cols">
                  <thead>
                    <tr>
                      <th></th> 
                      <td>Strategy</td> 
                      <td>Max Loss Probability</td> 
                      <td>Max Loss</td> 
                      <td>Avg Gain</td> 
                      <td>Stake Increase</td>
                      <td>Avg Rounds to Max Loss</td>
                      <td>Lowest Spins</td>
                      <td>Max Loss Chance</td>
                      <th></th> 
                    </tr>
                  </thead> 
                  <tbody>
                    <tr v-for="strategy in ordered_strategies">
                      <th></th> 
                      <!-- Open the modal using ID.showModal() method -->
                      <td><button class="btn btn-sm w-full" @click="open_modal(strategy.name)">[[strategy.name]]</button></td> 
                      <td>[[parseFloat(strategy.probability).toFixed(6)]]%</td> 
                      <td>$[[parseFloat(strategy.max_loss).toFixed(2)]]</td> 
                      <td>$[[parseFloat(strategy.avg_gain).toFixed(2)]]</td> 
                      <td>[[((parseFloat(strategy.current_ratio)-1)*100)]]%</td> 
                      <td>[[(1/(parseFloat(strategy.probability))*100).toFixed(0)]]</td>
                      <td><button class="btn btn-sm w-full" @click="open_spins_modal(strategy.name)">[[strategy.spins_ml[strategy.spins_ml.length -1].spins.toFixed(0)]]</button></td>
                      <td>[[strategy.spins_ml[strategy.spins_ml.length -1].perc.toFixed(2)]]%</td>                      
                      <th></th> 
                    </tr>
                  </tbody> 
                  <tfoot>
                    <tr>
                      <th></th> 
                      <td>Strategy</td> 
                      <td>Max Loss Probability</td> 
                      <td>Max Loss</td> 
                      <td>Avg Gain</td> 
                      <td>Stake Increase</td>
                      <td>Avg Rounds to Max Loss</td>
                      <td>Lowest Spins</td>
                      <td>Max Loss Chance</td>
                      <th></th> 
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
            <dialog id="my_modal_2" class="modal">
              <div class="modal-box">
                <h3 class="text-lg font-bold">[[ modal_strategy_name ]]</h3>
                <br>
                <h3 class="text-sm">Bet Progression</h3>
                <div class="overflow-x-auto">
                  <table class="table table-md  table-pin-cols">
                    <thead>
                      <tr>
                        <th></th> 
                        <td>#</td> 
                        <td>Amt per Unit</td> 
                        <td>Total Loss</td> 
                        <th></th> 
                      </tr>
                    </thead> 
                    <tbody>
                      <tr v-for="item in modal_bets">
                        <th></th> 
                        <!-- Open the modal using ID.showModal() method -->
                        <td>[[ modal_bets.indexOf(item) + 1 ]]</td> 
                        <td>[[ item.bet ]]</td> 
                        <td>[[ item.total_loss ]]</td> 
                        <th></th> 
                      </tr>
                    </tbody> 
                  </table>
                </div>
                </div>
              <form method="dialog" class="modal-backdrop">
                <button>close</button>
              </form>
            </dialog>
            <dialog id="my_modal_3" class="modal">
              <div class="modal-box">
                <h3 class="text-lg font-bold">[[ modal_strategy_name ]]</h3>
                <br>
                <h3 class="text-sm">Spins</h3>
                <div class="overflow-x-auto">
                  <table class="table table-md  table-pin-cols">
                    <thead>
                      <tr>
                        <th></th> 
                        <td>Spins</td> 
                        <td>Change of Max Loss</td> 
                        <td>Possible Amt</td> 
                        <th></th> 
                      </tr>
                    </thead> 
                    <tbody>
                      <tr v-for="item in modal_spins">
                        <th></th> 
                        <!-- Open the modal using ID.showModal() method -->
                        <td>[[ item.spins.toFixed(0) ]]</td> 
                        <td>[[ item.perc.toFixed(2) ]]%</td> 
                        <td>$[[ item.amt.toFixed(2) ]]</td> 
                        <th></th> 
                      </tr>
                    </tbody> 
                  </table>
                </div>
                </div>
              <form method="dialog" class="modal-backdrop">
                <button>close</button>
              </form>
            </dialog>
          </div> 

          <div class="drawer-side">
            <label for="my-drawer-3" aria-label="close sidebar" class="drawer-overlay"></label> 
            <ul class="menu p-4 w-80 min-h-full bg-base-200 space-y-2">
              <!-- Sidebar content here -->
              <li>
                  <input type="number" placeholder="Banker % Fee" v-model="banker_perc" class="input-sm input-bordered w-full h-full max-w-xs" />
              </li>
              <li>
                  <input type="number" placeholder="Min Bet" v-model="min_bet" class="input-sm input-bordered w-full h-full max-w-xs" />
              </li>
              <li>
                <input type="number" placeholder="Max Bet" v-model="max_bet" class="input-sm input-bordered w-full h-full max-w-xs" />
              </li>
              <li>
                <input type="number" placeholder="Max Loss" v-model="max_loss" class="input-sm input-bordered w-full h-full max-w-xs" />
              </li>
              <li>
                <button class="btn btn-sm h-full bg-sky" @click="calculate()">Calculate</button>
              </li>
            </ul>
          </div>

        </div>      
      </div>
    </center>
  </div>
</body>
<!-- <script>
  // Disable right-clicking
document.addEventListener('contextmenu', function(event) {
    event.preventDefault();
});
</script> -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js', { scope: '/' });
  }
</script>
<script src="go_modules/wasm_exec.js"></script>
  <script>
    const { createApp } = Vue
    
    createApp({
      delimiters : ['[[', ']]'],
        data(){
          return {
            message: 'Welcome to Gupy!',
            pyodide_msg: 'This is from Pyodide!',
            data: {},
            total_numbers: 36,
            virtual: false,
            minimize: true,
            banker_perc: .05,
            min_bet: '',
            max_bet: '',
            max_loss: '',
            strategies: [
              {
                name: 'Player Bets',
                coverage: 18,
                unit_size: 1,
                ratio: 2,
                profit_ratio: 1,
                break_even_ratio: 2,
                risk: 1,
                bets: [
                  {
                    bet: 0,
                    total_loss: 0,
                    gain: 0
                  }
                ],
                probability: 0,
                avg_gain: 0,
                max_simultanious_bets: 6,
                traditional_min_units: 1
              },
              {
                name: 'Banker Bets',
                coverage: 18,
                unit_size: 1,
                ratio: 2,
                profit_ratio: 1-(this.banker_perc),
                break_even_ratio: 2+(this.banker_perc),
                risk: 1,
                bets: [
                  {
                    bet: 0,
                    total_loss: 0,
                    gain: 0
                  }
                ],
                probability: 0,
                avg_gain: 0,
                max_simultanious_bets: 6,
                traditional_min_units: 1
              },
            ],
            failed_input: false,
            calculated: false,
            ordered_strategies: [],
            modal_strategy_name: '',
            modal_bets: [],
            modal_spins: [],
          }
        },
        methods: {
          open_spins_modal(strategy){
            this.modal_strategy_name = strategy;
            this.modal_spins = [];
            for (var item of this.strategies){
              if (item.name == strategy){
                this.modal_spins = item.spins_ml;
                console.log(strategy)
                console.log('strategy: '+JSON.stringify(item))
              }
            }
            console.log('modal spins: '+JSON.stringify(this.modal_spins))
            var modal = document.getElementById('my_modal_3');
            modal.showModal()
          },
          open_modal(strategy){
            this.modal_strategy_name = strategy;
            this.modal_bets = [];
            for (var item of this.strategies){
              if (item.name == strategy){
                this.modal_bets = item.bets;
                console.log(strategy)
                console.log('strategy: '+JSON.stringify(item))
              }
            }
            console.log('modal bets: '+JSON.stringify(this.modal_bets))
            var modal = document.getElementById('my_modal_2');
            modal.showModal()
          },
          calculate(){
    this.ordered_strategies = [];
    this.failed_input = false;

    if (!this.min_bet || !this.max_bet || !this.max_loss ||
        this.min_bet <= 0 || this.max_bet <= 0 || this.max_loss <= 0){
      this.failed_input = 'Improper inputs for Min Bet, Max Bet, & Max Loss';
      this.calculated = false;
      return;
    }

    const maxLossLimit = parseFloat(this.max_loss);
    const maxBetLimit  = parseFloat(this.max_bet);
    const bankerFee    = parseFloat(this.banker_perc || 0);   // e.g. 0.05
    const bankerPayout = 1 - bankerFee;                       // net per unit on Banker win

    // Helper: single-win gain (kept for display)
    function gainIfWin(bet, totalLossAfterPlacing, profitRatio, risk){
      const lossBefore = totalLossAfterPlacing - bet * risk;
      return bet * profitRatio - lossBefore;
    }

    for (let strategy of this.strategies){
      // Recompute profit_ratio dynamically (Banker may change fee)
      if (strategy.name.toLowerCase().includes('banker')){
        strategy.profit_ratio = bankerPayout;
      } else {
        strategy.profit_ratio = 1;
      }

      const risk = strategy.risk || 1;
      let baseUnit = Math.ceil(strategy.unit_size * this.min_bet);
      if (baseUnit < 1) baseUnit = 1;

      let totalLoss = 0;
      strategy.bets = [];
      let pairIndex = 0;

      while (totalLoss < maxLossLimit){
        let betSize;

        if (pairIndex === 0){
          // Initial pair always base unit
          betSize = baseUnit;
        } else {
          if (strategy.name.toLowerCase().includes('player')){
            // Player even‑money: half of current total loss
            betSize = Math.ceil(totalLoss / 2);
          } else {
            // Banker: adjust for commission so two wins cover totalLoss
            // 2 * betSize * bankerPayout ≈ totalLoss  => betSize = totalLoss / (2*bankerPayout)
            betSize = Math.ceil(totalLoss / (2 * bankerPayout));
          }
        }

        if (betSize <= 0) betSize = baseUnit;
        if (betSize > maxBetLimit) break;

        // First bet of pair
        const nextLoss1 = totalLoss + betSize * risk;
        if (nextLoss1 > maxLossLimit) break;
        totalLoss = nextLoss1;
        strategy.bets.push({
          bet: betSize,
          total_loss: totalLoss,
          gain: gainIfWin(betSize, totalLoss, strategy.profit_ratio, risk)
        });

        // Second bet of pair (same size)
        const nextLoss2 = totalLoss + betSize * risk;
        if (nextLoss2 > maxLossLimit || betSize > maxBetLimit) break;
        totalLoss = nextLoss2;
        strategy.bets.push({
          bet: betSize,
          total_loss: totalLoss,
          gain: gainIfWin(betSize, totalLoss, strategy.profit_ratio, risk)
        });

        pairIndex += 1;
      }

      // Stats
      if (strategy.bets.length){
        strategy.max_loss = strategy.bets[strategy.bets.length - 1].total_loss;
        // Keep your existing probability formula (coverage retained for compatibility)
        strategy.probability =
          (((this.total_numbers - strategy.coverage)/this.total_numbers) ** strategy.bets.length) * 100;
        const mid = Math.min(strategy.bets.length - 1, Math.floor(strategy.bets.length / 2));
        strategy.avg_gain = strategy.bets[mid].gain;
      } else {
        strategy.max_loss = 0;
        strategy.probability = 0;
        strategy.avg_gain = 0;
      }

      // Construct spins_ml similar to prior logic
      let bustProb = parseFloat(strategy.probability)/100;
      let avgMaxLossSpins = 1 / (bustProb || 1);
      strategy.spins_ml = [];
      while (avgMaxLossSpins > 0){
        avgMaxLossSpins -= 50;
        if (avgMaxLossSpins > 0){
          const perc = (1 - Math.pow(1 - bustProb, avgMaxLossSpins)) * 100;
            const amt  = avgMaxLossSpins * strategy.avg_gain;
          strategy.spins_ml.push({ spins: avgMaxLossSpins, perc, amt });
        }
      }
      if (!strategy.spins_ml.length){
        strategy.spins_ml.push({ spins: 0, perc: 100, amt: 0 });
      }

      // Effective ratio display (pair system – treat as 1)
      strategy.current_ratio = 1;
    }

    this.ordered_strategies = this.strategies.slice().sort((a,b)=>a.probability - b.probability);
    this.calculated = true;                    
      },
          change_total_numbers(){
            if (this.total_numbers == 38){
              this.total_numbers = 37;
            } else {
              this.total_numbers = 38;
            }
          },
        },
        watch: {

        },
        created(){
            // Make a request for a user with a given ID
            axios.get('/api/example_api_endpoint')
            .then(function (response) {
                // handle success
                console.log(response);
                this.data = JSON.parse(JSON.stringify(response['data']))
                console.log(this.data)
            })
            .catch(function (error) {
                // handle error
                console.log(error);

            // use pyodide instead of api example
        async function main(
          pyodide_msg,
        ){
          const pyodide = await loadPyodide();
          pyodide.registerJsModule("mymodule", { 
            pyodide_msg:pyodide_msg,
        })
        await pyodide.loadPackage("numpy")
        await pyodide.runPython(`
from mymodule import *

pyodide_msg = 'This is the changed pyodide message!'

response = {'new_msg':pyodide_msg}
`)
      main(this.pyodide_msg).then(response => {
        response = JSON.parse(response['new_msg'])
        console.log(response)
                
            })
            .finally(function () {
                // always executed
            });
          }
        })
      },
        mounted() {
          const go = new Go();
          WebAssembly.instantiateStreaming(fetch("go_modules/go_module.wasm"), go.importObject).then((result) => {
            go.run(result.instance);
          });

          let worker = new Worker('worker.js');
          worker.postMessage({ message: '' });
          worker.onmessage = function (message) {
            console.log(message.data)
          }

        },
        computed:{

        }

    }).mount('#app')
  </script>
</html>      
